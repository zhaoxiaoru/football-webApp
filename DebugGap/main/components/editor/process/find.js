function doStackWork(e,t,a){var s,l=pathStack.splice(0,maxLimit);if(l.length){for(s=0;s<l.length;s++)a?_replace(l[s],e,t,a):_find(l[s],e,t);timeInstance=setTimeout(doStackWork,5)}else t(null),clearTimeout(timeInstance)}function find(e,t,a,s,l){findAction(e,t,a,s,l)}function replace(e,t,a,s,l,n){findAction(e,t,a,s,n,l)}function findAction(e,t,a,s,l,n){a=new Function("return "+a)(),s=s.trim()?new RegExp("^("+s.split(" ").join("|")+")$","i"):null;var c=[],i=function(e){doneFileNum++,e?(c.push(e),c.length==maxLimit?(l({data:c,total:totalFileNum,done:doneFileNum}),c=[]):totalFileNum==doneFileNum&&c.length&&(l({data:c,total:totalFileNum,done:doneFileNum}),l({EOF:!0}))):null===e&1==doneFileNum&&l({data:c,total:totalFileNum,done:doneFileNum})},r=null;t&&(r=new Function("return /\\.("+t.split(" ").join("|")+")$/i")()),_search(e,r,s,i),doStackWork=n?doStackWork.bind(null,a,i,n):doStackWork.bind(null,a,i),setTimeout(doStackWork,50)}function getPathSplitChar(){return/^win/i.test(process.platform)?"\\":"/"}function _search(e,t,a,s){var l=require("fs");l.readdir(e,function(n,c){if(n)return totalFileNum++,void s({success:0});var i,r,o;totalFileNum+=c.length;for(var u=0,p=c.length;p>u;u++)i=c[u],o=e+i,r=l.statSync(o),r.isDirectory()?(totalFileNum--,a&&a.test(i)||_search(o+getPathSplitChar(),t,a,s)):excludeExtReg.test(i)||t&&!t.test(i)?totalFileNum--:pathStack.push(o)})}function _replace(e,t,a,s){var l=require("fs");l.readFile(e,function(n,c){if(n)return void a({success:0});c=c.toString();var i,r,o,u,p,h,m=[];c?(c=c.replace(t,function(e,t,a){return i=a.slice(0,t).split("\n"),r=i.pop(),p=r.length,u=i.length+1,r=r.replace(/^\s+|\s+$/g," "),o=a.slice(t+e.length).split("\n").shift().replace(/^\s+|\s+$/g," "),h=r.length>100?_htmlspecialchars("..."+r.slice(-50))+'<span class="ace_storage ace_type">'+s+"</span>"+_htmlspecialchars(o.slice(0,50)+"..."):o.length>100?_htmlspecialchars(r)+'<span class="ace_storage ace_type">'+s+"</span>"+_htmlspecialchars(o.slice(0,50)):_htmlspecialchars(r)+'<span class="ace_storage ace_type">'+s+"</span>"+_htmlspecialchars(o),m.push({row:u,column:p,line:h}),s}),l.writeFile(e,c,function(t){a(t?{success:0}:{success:1,match:m,path:e})})):a({success:0})})}function _find(e,t,a){var s=require("fs");s.readFile(e,function(s,l){if(s)return void a({success:0});l=l.toString();var n,c,i,r,o,u,p=[];l&&l.replace(t,function(e,t,a){n=a.slice(0,t).split("\n"),c=n.pop(),o=c.length,r=n.length+1,c=c.replace(/^\s+|\s+$/g," "),i=a.slice(t+e.length).split("\n").shift().replace(/^\s+|\s+$/g," "),u=c.length>100?_htmlspecialchars("..."+c.slice(-50))+'<span class="ace_storage ace_type">'+e+"</span>"+_htmlspecialchars(i.slice(0,50)+"..."):i.length>100?_htmlspecialchars(c)+'<span class="ace_storage ace_type">'+e+"</span>"+_htmlspecialchars(i.slice(0,50)):_htmlspecialchars(c)+'<span class="ace_storage ace_type">'+e+"</span>"+_htmlspecialchars(i),p.push({row:r,column:o,line:u})}),a({success:1,match:p,path:e})})}function _htmlspecialchars(e){var t="";if(void 0==e)return"undefined";if("number"==typeof e)return e+"";if(0==e.length)return"";for(var a=0;a<e.length;a++)switch(e.substr(a,1)){case"<":t+="&lt;";break;case">":t+="&gt;";break;case"&":t+="&amp;";break;case" ":t+=" &nbsp;";break;case'"':t+="&quot;";break;default:t+=e.substr(a,1)}return t}var totalFileNum=0,doneFileNum=0,maxLimit=50,pathStack=[],excludeExtReg=/\.(jpg|jpeg|png|gif|bmp|ico|ttf|eot|woff|zip|rar|mp4)$/i,timeInstance=null;module.exports={find:find,replace:replace};