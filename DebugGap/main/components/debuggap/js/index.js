!function(){function e(e){var t=require("child_process").exec;t("ipconfig",function(n,o){if(n)t("ifconfig",function(t,n){try{var o,r=n.match(/inet addr:(\S+)/);if(r&&r[1])o=r[1];else{r=n.match(/inet\s(\S+)/g);for(var i=0;i<r.length&&(o=r[i].match(/inet.*?([0-9.]+)/)[1],"127.0.0.1"==o);i++);}}catch(s){}finally{e(o)}});else{var r=o.match(/IPv4[^:]+:\s*(\S+)/)[1];e(r)}})}function t(){var e="ws://"+g.host+":"+g.port;g.name&&(e+="/"+g.name);try{p=new WebSocket(e,g.protocal),p.onopen=function(e){localStorage.host=g.host,localStorage.port=g.port,localStorage.hostExpired=Math.ceil((new Date).getTime()/1e3)+10800,a("Server is ready to receive remote mobile devices")},p.onmessage=function(e){r(e.data)},p.onclose=function(e){a("There is something wrong with your machine,please check your network/IP or firewall","error"),i()},n()}catch(t){c(t)}}function n(){setTimeout(function(){1!=p.readyState&&a("Your machine is too slow to run DebugGap,please wait...")},3e3)}function o(){(new h).start(g.host,g.port)}function r(e){var e=decodeURIComponent(e).split("_debuggap_"),t=e[0];if("close"==e[1])$("#"+t).length&&($("#"+t).remove(),$("h3 span").html(--m));else if(!$("#"+t).length){var n=e[1],e='<li id="'+t+'"><a target="_blank" onclick="window.open(\'./child.html?id='+t+"&url="+encodeURIComponent(e[2])+'\')" href="javascript:void(0)"><b>ID</b>: '+e[0]+"<hr/><b>URL</b>:<br/> "+e[2]+"<br/><br/><b>Device Info</b>:<br/> "+e[1]+"</a></li>";$("#list").append(e),$("h3 span").html(++m)}v.track(v.filterPlatform(n))}function i(){$("h3 span").html(0),$("#list").html("")}function s(){k.register(".l-console",function(){$(".l-btn").addClass("l-btn-show"),$(".l-console").addClass("l-console-hide")})}function a(e,t){if(e=e.replace(/\\n/g,"<br/>"),t)if("error"==t)e='<span class="l-con-err">'+e+"<span>",$(".l-btn").addClass("l-btn-err");else if("object"==typeof t){var n="";jQuery.each(t,function(e,t){n+=e+":"+t+";"}),n=n.slice(0,-1),e='<span style="'+n+'">'+e+"<span>"}e="<pre>"+e+"</pre>";var o=$(".l-con pre").length;o>100&&(o-=100,$(".l-con pre:lt("+o+")").remove()),$(".l-con").append(e),$(".l-con")[0].scrollTop=9999}function c(e,t){if(0==$(".msg").length){var n=document.createElement("div");n.className="msg",document.body.appendChild(n)}$(".msg").text(e),$(".msg").css({display:"block",opacity:1}),t="undefined"==typeof t?2e3:t,t&&setTimeout(function(){$(".msg").css({opacity:0}),setTimeout(function(){$(".msg").css({display:"none"})},500)},t)}function l(){this.get=function(e,t,n){var o=I.parse(e);o.headers=n,_.get(o,function(e){console.log("Got response: "+e.statusCode);var n=new Buffer(0);e.on("data",function(e){n=Buffer.concat([n,e])}),e.on("end",function(){t&&t(n)})}).on("error",function(e){console.log("Got error: "+e.message)})}}function u(){this.getData=function(e,t,n){var o=this.parseHeader(e),r=C.createHash("md5").update(o.requestHeaders["User-Agent"]).digest("hex");o.requestHeaders.innerUse||"true"==o.requestHeaders.XHR||t(r,o),this.handleException(o,n)||this.sendRequest(r,o,n)},this.sendRequest=function(e,t,n){var o=t.requestHeaders,r="http:"==t.location.protocol?_:S;o.host=t.location.host,o.path=t.location.path,o.method=t.method;var i=r.request(o,function(r){var i=new Buffer(0);r.on("data",function(e){i=Buffer.concat([i,e])}),r.on("end",function(){var s={statusCode:r.statusCode,id:t.id,data:i,responseHeaders:r.headers,requestHeaders:o,pathname:t.location.pathname,innerUse:t.requestHeaders.innerUse,host:o.host};n(e,s)}),r.on("error",function(){console.log(arguments)})});i.on("error",function(r){h.log("problem with request: "+r+" url:"+o.host);var i={statusCode:"500",id:t.id,data:"",size:"",responseHeaders:{},pathname:t.location.pathname};"ENOTFOUND"==r.code&&(i.statusCode="404"),n(e,i)}),"get"!=t.method.toLowerCase()&&i.write(t.payload),i.end()},this.handleException=function(e,t){return/debuggap_get_proxy/.test(e.location.path)?(t(null,{data:new Buffer(JSON.stringify(g.host+":"+g.port))}),!0):!1},this.parseHeader=function(e){e=e.toString().trim("\r\n"),e=e.split("\r\n");var t=e.shift().split(" "),n={},o={},r=null;for(var i in e)if(e[i]){var s=e[i].indexOf(":");-1==s?(r=e[i],o.payload=r):n[e[i].slice(0,s)]=e[i].slice(s+1).trim(" ")}return o.method=t[0],o.location=I.parse(t[1]),o.httpVersion=t[2],o.requestHeaders=n,o}}function d(){this.routes={post:{"/scriptSocket":"send_script_socket"},get:{"/":"server_status","/scriptSocket/init":"script_socket_init","/scriptSocket":"get_script_socket","/scriptSocket/close":"close_script_socket","/proxy":"proxy","/injectCss":"injectCss"},options:"deal_options"},this.get_function_name=function(e,t){var n=this.routes[e.toLowerCase()],o=null;return"object"==typeof n?(o=n[t],o||(o="request_error")):o=n?n:"request_error",o}}function h(){var e=[];this.index=null;var t={};this.scriptData={};var n=new u,o=new l;this.routing=new d,this.start=function(){var e=this;server=y.createServer(function(o){var a,c,l=e.createClient(o),u=0,d=0;o.on("data",function(r){if(l.isHttps)return void c.write(r);var f=r.toString();if(129==r[0]||0!=d){if(129==r[0]){var p=127&r[1];d=127==p?r.readUInt32BE(2)*Math.pow(2,32)+r.readUInt32BE(6)+14:126==p?r.readUInt16BE(2)+8:p+6,a=new Buffer(d)}if(r.copy(a,u),u+=r.length,d>u)return;d=0,u=0}else if(f.match(/^GET \/debuggap_/))a=r;else{if(f.match(/^[A-Z]+\shttp/)||f.match(/^CONNECT/)){if(f.match(/^CONNECT/)){var r=f,g=r.match(/CONNECT\s([^\s]+)\s/)[1];return g=g.split(":"),443==g[1]&&(c=new y.Socket,c.connect(g[1],g[0]),c.on("data",function(e){o.write(e)}),l.isHttps=1),void o.end(new Buffer("HTTP/1.1 200 Connection established\r\nConnection: close\r\n\r\n"))}s(l);var m=(new Date).getTime();return void n.getData(r,function(e,n){n.id=1e3*(new Date).getTime()+Math.floor(1e3*Math.random());var o=i(e);o?o.communicate("initRequest:"+JSON.stringify(n)):t[n.location.host]=1},function(e,n){var r=i(e);n.times=(new Date).getTime()-m,o.end(n.data),!r||n.innerUse||n.requestHeaders.XHR?!r&&e&&(t[n.host]=1):(/\.(jpg|jpeg|gif|png|bmp)$/.test(n.pathname.toLowerCase())?(n.size=n.data.length,delete n.data):(n.data=n.data.toString("utf8"),n.size=Buffer.byteLength(n.data)),delete n.pathname,r.communicate("resultRequest:"+JSON.stringify(n)))})}if(0==r[0])a=r;else{var v=new Buffer(a.length+r.length);a.copy(v,0,0,a.length),r.copy(v,a.length,0,r.length),a=v,delete v}if(255!=r[r.length-1])return}if(l.finishHandShake)if("debuggap_client"==l.uniqueId){if(l.clientInfo=decodeURIComponent(l.decode(a)).slice(11),!l.clientInfo)return;var g=l.clientInfo.split("_debuggap_");if(g&&g[0]){if(3!=g.length)return void h.log("Please upgrade your debuggap.js("+manifest.version+") file","error");if(g[0]!=manifest.version)return void h.log("version of DebugGap client("+g[0]+") does not match this remote version("+manifest.version+")","error");l.clientInfo=g[1],l.url=g[2]}l.clientInfo=l.clientInfo.replace(/\s+\([^)]{1,2}\)$/,"");var b=C.createHash("md5").update(l.clientInfo+l.url).digest("hex"),w=i(b);if(w)return h.log("this client has existed!","error"),s(w),void(l.uniqueId=b);l.uniqueId=b,e.noticeIndexPage(b,l.clientInfo,l.url),l.communicate("ready:true")}else{var k=decodeURIComponent(l.decode(a).toString());l.dstClient==l.socket&&e.scriptData[l.uniqueId.substr(14)]?(k=encodeURIComponent(k),e.scriptData[l.uniqueId.substr(14)].go.push(k)):l.communicate(k)}else{var S=l.handShake(a);if("debuggap_index"==S)e.index=l,e.index.dstClient=l.socket;else if("debuggap_child"==S.substr(0,14)){S=S.substr(14);var _=i(S);_?(l.communicate("ready:true"),l.dstClient=_.socket,_.dstClient=l.socket,_.earlyWebsocket&&(l.toEarlyWebsocket=1)):e.scriptData[S]?l.communicate("ready:true"):l.communicate("ready:false")}else"debuggap_client"==S&&h.log("new client comes")}}),o.on("close",function(t){var n=r(o);n&&n.clientInfo&&n.uniqueId&&(e.index.communicate(n.uniqueId+"_debuggap_close"),n.dstClient&&n.dstClient.destroy()),s(n),h.log("one client has closed"),delete o})}),server.listen(g.port,g.host,function(){h.log("Remote DebugGap:"+g.host+":"+g.port,{"font-size":"20px","text-align":"center",width:"100%","border-bottom":"2px dotted #ccc",display:"inline-block",padding:"10px 0px","margin-bottom":"5px"})}),server.on("connection",function(e){e.setTimeout(0),e.setNoDelay(!0),e.setKeepAlive(!0,0)}),server.on("close",function(){h.log("server is down,it's restarting"),e.start()});var o=_.createServer(function(t,n){var o=new Buffer(0),r=e.routing.get_function_name(t.method,t.url.split("?")[0]);t.on("data",function(e){o=Buffer.concat([o,e])}),t.on("end",function(){frameString=o.toString(),e[r].call(e,n,frameString,t)})});o.listen(parseInt(g.port)+1,g.host,function(){console.log("http server starts")})},this.deal_options=function(e,t){e.writeHead("200",{"Access-Control-Allow-Methods":"GET, POST","Access-Control-Allow-Headers":"innerUse,XHR,origin,content-type","Access-Control-Allow-Origin":"*"}),e.end()},this.server_status=function(e){this.common_output(e,200,"it works")},this.request_error=function(e){this.common_output(e,500,"error")},this.script_socket_init=function(e,t,n){var o=C.createHash("md5").update(n.headers["user-agent"]+n.headers.referer).digest("hex");this.scriptData[o]={come:[],go:[],noticeIndex:0},e.writeHead(200,{"Content-Type":"application/javascript"}),e.end("debuggap.scriptSocket.handShake()"),h.log("new client comes")},this.get_script_socket=function(e,t,n){var o=C.createHash("md5").update(n.headers["user-agent"]+n.headers.referer).digest("hex"),r="";if(this.scriptData[o]&&this.scriptData[o].go.length&&(r=this.scriptData[o].go.shift(),r="debuggap.scriptSocket.handle('"+r+"')"),e.writeHead(200,{"Content-Type":"application/javascript"}),e.end(r),this.scriptData[o]&&this.scriptData[o].come.length){var s=i("debuggap_child"+o);s&&(r=this.scriptData[o].come.shift(),s.communicate(r))}},this.send_script_socket=function(e,t,n){var o=C.createHash("md5").update(n.headers["user-agent"]+n.headers.referer).digest("hex"),r="";this.scriptData[o]&&!this.scriptData[o].noticeIndex?(this.scriptData[o].noticeIndex=1,this.noticeIndexPage(o,n.headers["user-agent"],n.headers.referer)):t&&(r=decodeURIComponent(t),this.scriptData[o].come.push(r)),this.common_output(e,200,"ok")},this.close_script_socket=function(e,t,n){var o=C.createHash("md5").update(n.headers["user-agent"]+n.headers.referer).digest("hex");this.index.communicate(o+"_debuggap_close"),h.log("one client has closed"),delete this.scriptData[o]},this.proxy=function(e,t,n){var r=n.url.match(/\/proxy\?url=(\S+)/),i=this;r&&r[1]&&o.get(decodeURIComponent(r[1]),function(t){i.common_output(e,200,t)},{Referer:"http://www.debuggap.com"})},this._injectCssObj={},this.injectCss=function(e,t,n){var o=n.url.replace("/injectCss?","").replace(/\+/g,"%20");o=decodeURIComponent(o);var r=o.split("&"),i={};if($.each(r,function(e,t){var n=t.split("=");i[n[0]]=n[1]}),!i.uniqueId)return void this.common_output(e,404,"Error");if("add"==i.type)this._injectCssObj[i.uniqueId]||(this._injectCssObj[i.uniqueId]={}),this._injectCssObj[i.uniqueId][i.title]||(this._injectCssObj[i.uniqueId][i.title]={}),this._injectCssObj[i.uniqueId][i.title][i.key]=i.value,this.common_output(e,200,"ok");else{if(e.writeHead("200",{"Content-Type":"text/css"}),this._injectCssObj[i.uniqueId]){i=this._injectCssObj[i.uniqueId];var s,a,c,l=[];for(c in i){l.push(c+"{"),s=i[c];for(var a in s)l.push(a+":"+s[a]+";");l.push("}\n")}l=l.join(""),console.log(l),e.write(l)}e.end()}},this.common_output=function(e,t,n){e.writeHead(t,{"Access-Control-Allow-Origin":"*","Content-Length":n.length}),e.end(n)},this.noticeIndexPage=function(e,t,n){this.index.communicate(e+"_debuggap_"+t+"_debuggap_"+n)};var r=function(t){for(var n=null,o=0;o<e.length;o++)if(e[o].socket==t){n=e[o];break}return n},i=function(t){for(var n=null,o=0;o<e.length;o++)if(e[o].uniqueId==t){n=e[o];break}return n},s=function(t){for(var n=0;n<e.length;n++)if(e[n]==t){e.splice(n,1);break}};this.createClient=function(t){var n=new f(t);return e.push(n),n}}function f(e){this.socket=e,this.dstClient=e,this.finishHandShake=!1,this.clientInfo="",this.url="",this.uniqueId="",this.earlyWebsocket=0,this.toEarlyWebsocket=0,this.getSocketHeader=function(e){e=e.toString("binary");var t,n={get:"",key:""};if((t=e.match(/GET \/(.*) HTTP\/1\.1\r\n/))&&(this.uniqueId=n.get=t[1]),(t=e.match(/Sec-WebSocket-Key: (.*)\r\n/))&&(n.key=t[1]),n.key){var o=C.createHash("sha1");o.update(n.key+"258EAFA5-E914-47DA-95CA-C5AB0DC85B11"),n.key=o.digest("base64")}else{var r,i="";(t=e.match(/Sec-WebSocket-Key1: (.*)\r\n/))&&(r=t[1],r=parseInt(r.replace(/[^0-9]/g,""))/parseInt(r.replace(/[^\s]/g,"").length),i+=String.fromCharCode.apply(null,[3,2,1,0].map(function(e){return r>>8*e&255}))),(t=e.match(/Sec-WebSocket-Key2: (.*)\r\n/))&&(r=t[1],r=parseInt(r.replace(/[^0-9]/g,""))/parseInt(r.replace(/[^\s]/g,"").length),i+=String.fromCharCode.apply(null,[3,2,1,0].map(function(e){return r>>8*e&255}))),(t=e.match(/Origin: (.*)\r\n/))&&(n.origin=t[1]),(t=e.match(/Host: (.*)\r\n/))&&(n.host=t[1]);try{r=e.match(/\r\n\r\n([\s\S]+)/)[1],i+=r,n.key=C.createHash("md5").update(i).digest("binary"),this.earlyWebsocket=1}catch(s){}}return n},this.handShake=function(e){var t=this.getSocketHeader(e);if(t.origin)var n="HTTP/1.1 101 WebSocket Protocol Handshake\r\nUpgrade: WebSocket\r\nConnection: Upgrade\r\nSec-WebSocket-Origin: "+t.origin+"\r\nSec-WebSocket-Location: ws://"+t.host+"/"+t.get+"\r\nSec-WebSocket-Protocol: websocket\r\n\r\n"+t.key;else var n="HTTP/1.1 101 Switching Protocols\r\nUpgrade: websocket\r\nConnection: Upgrade\r\nSec-WebSocket-Protocol: websocket\r\nSec-WebSocket-Accept: "+t.key+"\r\n\r\n";return this.socket.write(n,"binary"),this.finishHandShake=!0,t.get},this.encode=function(e){var t;if(this.toEarlyWebsocket){var n=0,o=255,e=e.toString(),r=2+Buffer.byteLength(e);t=new Buffer(r),t[0]=n,t.write(e,1),t[r-1]=o}else{Buffer.isBuffer(e)||(e=new Buffer(e));var r=e.length;if(126>r)t=new Buffer(r+2),t[0]=129,t[1]=r,e.copy(t,2,0);else if(r<Math.pow(2,16))t=new Buffer(r+4),t[0]=129,t[1]=126,t.writeUInt16BE(r,2),e.copy(t,4,0);else{t=new Buffer(r+10),t[0]=129,t[1]=127;var i=Math.floor(r/Math.pow(2,32)),s=r%Math.pow(2,32);t.writeUInt32BE(i,2),t.writeUInt32BE(s,6),e.copy(t,10,0)}}return t},this.decode=function(e){if(this.earlyWebsocket)return e.slice(1,e.length-1);var t,n,o=127&e[1];if(126>o)t=new Buffer(e.length-6),n=e.slice(2,6),e.copy(t,0,6);else if(126==o)t=new Buffer(e.length-8),n=e.slice(4,8),e.copy(t,0,8);else{var t=new Buffer(e.length-14);n=e.slice(10,14),e.copy(t,0,14)}for(var r=0;r<t.length;r++)t[r]^=n[r%4];return t},this.communicate=function(e,t){this.dstClient&&(t?e=this.encode(this.decode(e)):(e=encodeURIComponent(e),e=this.encode(e)),this.dstClient.write(e))}}$(document).ready(function(){document.title+=" v"+manifest.version,e(function(e){var t=Math.ceil((new Date).getTime()/1e3);t<localStorage.hostExpired&&localStorage.host&&localStorage.port&&localStorage.previousIP==e?g.host=localStorage.host:(localStorage.previousIP=e,g.host=e),localStorage.port?g.port=localStorage.port:g.port="11111",g.host||(g.host=localStorage.host),$(".l-connect .ip").val(g.host),$(".l-connect .port").val(g.port)}),$(".l-btn").on("click",function(){$(this).removeClass("l-btn-show"),$(".l-console").removeClass("l-console-hide"),$(".l-btn").removeClass("l-btn-err")}),$(".l-connect .connect").on("click",function(){g.host=$(".l-connect .ip").val(),g.port=$(".l-connect .port").val(),g.host&&g.port&&($(".l-connect").addClass("l-connect-action"),o(),setTimeout(function(){$("#clientList").show(),t(),$(".l-console").removeClass("l-console-action"),setTimeout(function(){$(".l-btn").addClass("l-btn-show"),$(".l-console").addClass("l-console-hide"),s()},2e3)},1e3))}),v.init()});var p,g={protocal:"websocket",name:"debuggap_index"},m=0,v={init:function(){var e='<div id="track" style="display:none;"><iframe src="http://www.debuggap.com/tooltrack/index.html" style="display:none;"></iframe></div>';$(document.body).append(e)},track:function(e){var t=$("#track iframe")[0].contentWindow.trackEvent;t&&t(["_setCustomVar",1,"mobileSystem",e,1])},filterPlatform:function(e){var t="webkit",n=e.match(/Android\s([0-9.]+)/);return/ipad|iphone/i.test(e)?(t="safari",n=e.match(/OS\s([0-9_]+)/)):/chrome/i.test(e)?t="chrome":/\.NET|MSIE/i.test(e)&&(t="ie",n=null),n&&n[1]&&(t+=" "+n[1]),t}},b=require("nw.gui"),w=b.Window.get();window.manifest=b.App.manifest,/child\.html$/.test(location.pathname)&&w.maximize();var k={data:[],func:function(e){for(var t,n=$(e.target),o=k.data,r=0,i=o.length;i>r;r++)t=o[r],0==n.closest(t.selector).length?t.blur?t.blur(t.selector):$(selector).hide():t.focus&&t.focus(t.selector)},init:function(){$(document).bind("click",k.func)},register:function(e,t,n){k.data.length||k.init();for(var o=0,r=k.data;r>o&&data[o].selector!=e;o++);o==r&&k.data.push({selector:e,focus:n||null,blur:t||null})},unregister:function(e){if(e){for(var t=k.data,n=0,o=t.length;o>n;n++)if(t[n].selector==e){t.splice(n,1);break}}else k.data=[];k.data.length||$(document).unbind("click",k.func)}};utility={isMouseover:function(e,t){var n=!1;return n=t.srcElement?e.contains(t.srcElement)&&!e.contains(t.fromElement):e.contains(t.target)&&!e.contains(t.relatedTarget)},isMouseout:function(e,t){var n=!1;return n=t.srcElement?e.contains(t.srcElement)&&!e.contains(t.toElement):e.contains(t.target)&&!e.contains(t.relatedTarget)}},function(){var e=require("nw.gui").App.manifest;if(!e.window.developing&&e.window.toolbar)for(;;);}();var y=require("net"),C=require("crypto"),S=require("https"),_=require("http"),I=require("url");h.log=function(){var e=0;if(e){var t,n=require("fs"),o=arguments[0];n.open("./1.log","a+",function(e,r){Buffer.isBuffer(o)?(t=new Buffer(o.length+2),o.copy(t,0),t.write("\rm")):t=new Buffer(o+"\r\n"),n.write(r,t,0,t.length)})}else a(arguments[0],arguments[1])},process.on("uncaughtException",function(e){})}();